<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: generateKeys.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: generateKeys.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import crypto from 'crypto';
import { buildBabyjub } from 'circomlibjs';

import {
  arrayBytesToHex,
  hasEvenY,
  bigIntFromHex,
  byteArrayToInt,
  hexFromBigInt,
  hexToArrayBytes,
  hexToBigInt,
  intToByteArray,
  x,
  y,
  updateJson,
  returnPrivateKey,
} from '../utils/utils.js';

import { signSchnorr } from '../signSchnorr/signSchnorr.js';

const babyJub = await buildBabyjub();

/**
 * Generates cryptographic key pairs and adds details to a JSON file.
 *
 * @param {number} numKeys - The number of key pairs to generate.
 * @returns {void}
 */
export const generateKeys = numKeys => {
  console.log(
    '> \x1b[32m[Key Generation] \x1b[0mGenerating',
    '[',
    numKeys,
    '] keys in "../../json/users.json"'
  );
  let count = 0;
  let object = {
    $schema: './users_schema.json',
    users: [],
  };

  while (count &lt; numKeys) {
    /**
     * Generate a random private key as a byte array.
     *
     * @type {Buffer}
     */
    const InitPrvKeyBytes = crypto.randomBytes(32);

    /**
     * Convert the byte array to an integer.
     *
     * @type {bigint}
     */
    const InitPrvKeyInt = byteArrayToInt(InitPrvKeyBytes) % babyJub.order;

    /**
     * Multiply the base public key by the private key.
     *
     * @param {object} point - Point on the elliptic curve.
     * @param {number} privateKey - The private key.
     * @returns {object} - The resulting public key point.
     */
    const pubKey = babyJub.mulPointEscalar(babyJub.Base8, InitPrvKeyInt);

    /**
     * Determine the private key based on Y evenness.
     *
     * @type {bigint}
     */
    let prvKey;
    if (hasEvenY(pubKey)) prvKey = InitPrvKeyInt;
    else prvKey = babyJub.order - InitPrvKeyInt;

    /**
     * Convert the public key to a byte array and then to a hexadecimal string.
     *
     * @type {string}
     */
    const pPubKey = babyJub.packPoint(pubKey);
    const pubKeyHex = arrayBytesToHex(pPubKey);

    /**
     * Convert the private key to a hexadecimal string.
     *
     * @type {string}
     */
    const prvKeyHex = hexFromBigInt(prvKey);

    /**
     * Generate a random message as a hexadecimal string.
     *
     * @type {string}
     */
    const msg = arrayBytesToHex(crypto.randomBytes(32));

    /**
     * Verify the key pair using the message and the private key.
     *
     * @type {boolean}
     */
    const isKeyGood = verifyKeyPair(msg, prvKeyHex, 'verKey');
    if (isKeyGood) {
      object.users.push({ publicKey: pubKeyHex, privateKey: prvKeyHex });
      count++;
    }
  }

  console.log(
    '> \x1b[32m[Key Generation] \x1b[0mGenerated [',
    numKeys,
    '] keys in "../json/users.json"'
  );

  /**
   * Update the JSON file with the generated key pairs.
   *
   * @type {void}
   */
  updateJson(object, '../json/users.json');
};

/**
 * Verify a key pair using Schnorr signature.
 *
 * @param {string} msg - The message to sign as a hexadecimal string.
 * @param {string} prvKeyHex - The private key as a hexadecimal string.
 * @returns {boolean} - `true` if verification succeeds, otherwise `false`.
 */
const verifyKeyPair = (msg, prvKeyHex) => {
  return signSchnorr(msg, prvKeyHex, 'verKey');
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#generateKeys">generateKeys</a></li><li><a href="global.html#verifyKeyPair">verifyKeyPair</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Sun Sep 03 2023 11:03:18 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
